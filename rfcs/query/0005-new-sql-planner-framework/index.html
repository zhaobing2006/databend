<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Built to make the Data Cloud easy."><meta name=author content=DatafuseLabs><link href=https://databend.rs/rfcs/query/0005-new-sql-planner-framework/ rel=canonical><link rel=icon href=../../../assets/favicon.png><meta name=generator content="mkdocs-1.2.3, mkdocs-material-7.1.4"><title>SQL Planner Framework - Databend</title><link rel=stylesheet href=../../../assets/stylesheets/main.2072d54a.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.bf7d808a.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-0D5KNCVTVR","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script> <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#sumamry class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> <a href=../../.. title=Databend> Databend </a> </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> SQL Planner Framework </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7 10a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2m10-3a5 5 0 0 1 5 5 5 5 0 0 1-5 5H7a5 5 0 0 1-5-5 5 5 0 0 1 5-5h10M7 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3h10a3 3 0 0 0 3-3 3 3 0 0 0-3-3H7Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=red data-md-color-accent=red type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/datafuselabs/databend/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> datafuselabs/databend </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../overview/building-and-running/ class=md-tabs__link> Documentation </a> </li> <li class=md-tabs__item> <a href=../../../cli/cli/ class=md-tabs__link> CLI </a> </li> <li class=md-tabs__item> <a href=../../../development/contributing/ class="md-tabs__link md-tabs__link--active"> Development </a> </li> <li class=md-tabs__item> <a href=../../../overview/performance/ class=md-tabs__link> Performance </a> </li> <li class=md-tabs__item> <a href=../../../overview/architecture/ class=md-tabs__link> Whitepapers </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=Databend class="md-nav__button md-logo" aria-label=Databend data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Databend </label> <div class=md-nav__source> <a href=https://github.com/datafuselabs/databend/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> datafuselabs/databend </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Documentation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Documentation data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Documentation </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1 type=checkbox id=__nav_2_1> <label class=md-nav__link for=__nav_2_1> Overview <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Overview data-md-level=2> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> Overview </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../overview/building-and-running/ class=md-nav__link> Installation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2 type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2> SQL Reference <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="SQL Reference" data-md-level=2> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> SQL Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_1 type=checkbox id=__nav_2_2_1> <label class=md-nav__link for=__nav_2_2_1> Data Types <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Data Types" data-md-level=3> <label class=md-nav__title for=__nav_2_2_1> <span class="md-nav__icon md-icon"></span> Data Types </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/data-types/data-type-integer-number/ class=md-nav__link> Integer Numbers </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/data-types/data-type-real-number/ class=md-nav__link> Real Numbers </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/data-types/data-type-string-types/ class=md-nav__link> String Types </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/data-types/data-type-time-date-types/ class=md-nav__link> Time and Date </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_2 type=checkbox id=__nav_2_2_2> <label class=md-nav__link for=__nav_2_2_2> Data Definition Language <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Data Definition Language" data-md-level=3> <label class=md-nav__title for=__nav_2_2_2> <span class="md-nav__icon md-icon"></span> Data Definition Language </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/data-definition-language-ddl/ddl-create-database/ class=md-nav__link> CREATE DATABASE </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/data-definition-language-ddl/ddl-drop-database/ class=md-nav__link> DROP DATABASE </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/data-definition-language-ddl/ddl-create-table/ class=md-nav__link> CREATE TABLE </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/data-definition-language-ddl/ddl-drop-table/ class=md-nav__link> DROP TABLE </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/data-definition-language-ddl/ddl-truncate-table/ class=md-nav__link> TRUNCATE TABLE </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_3 type=checkbox id=__nav_2_2_3> <label class=md-nav__link for=__nav_2_2_3> Data Manipulation Language <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Data Manipulation Language" data-md-level=3> <label class=md-nav__title for=__nav_2_2_3> <span class="md-nav__icon md-icon"></span> Data Manipulation Language </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/data-manipulation-language-dml/dml-select/ class=md-nav__link> SELECT </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/data-manipulation-language-dml/dml-insert/ class=md-nav__link> INSERT </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_4 type=checkbox id=__nav_2_2_4> <label class=md-nav__link for=__nav_2_2_4> Describe Commands <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Describe Commands" data-md-level=3> <label class=md-nav__title for=__nav_2_2_4> <span class="md-nav__icon md-icon"></span> Describe Commands </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/describe-commands/describe-table/ class=md-nav__link> DESCRIBE TABLE </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_5 type=checkbox id=__nav_2_2_5> <label class=md-nav__link for=__nav_2_2_5> Show Commands <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Show Commands" data-md-level=3> <label class=md-nav__title for=__nav_2_2_5> <span class="md-nav__icon md-icon"></span> Show Commands </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/show-commands/show-create-table/ class=md-nav__link> SHOW CREATE TABLE </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/show-commands/show-databases/ class=md-nav__link> SHOW DATABASES </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/show-commands/show-processlist/ class=md-nav__link> SHOW PROCESSLIST </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/show-commands/show-tables/ class=md-nav__link> SHOW TABLES </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/show-commands/show-settings/ class=md-nav__link> SHOW SETTINGS </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/show-commands/show-metrics/ class=md-nav__link> SHOW METRICS </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_6 type=checkbox id=__nav_2_2_6> <label class=md-nav__link for=__nav_2_2_6> Kill Commands <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Kill Commands" data-md-level=3> <label class=md-nav__title for=__nav_2_2_6> <span class="md-nav__icon md-icon"></span> Kill Commands </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/kill-commands/kill-query/ class=md-nav__link> KILL QUERY </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_7 type=checkbox id=__nav_2_2_7> <label class=md-nav__link for=__nav_2_2_7> Aggregate Functions <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Aggregate Functions" data-md-level=3> <label class=md-nav__title for=__nav_2_2_7> <span class="md-nav__icon md-icon"></span> Aggregate Functions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-avg/ class=md-nav__link> AVG </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-count/ class=md-nav__link> COUNT </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-min/ class=md-nav__link> MIN </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-max/ class=md-nav__link> MAX </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-sum/ class=md-nav__link> SUM </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-combinator/ class=md-nav__link> DISTINCT </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-argmin/ class=md-nav__link> argMin </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-argmax/ class=md-nav__link> argMax </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-avg-if/ class=md-nav__link> avgIf </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-count-if/ class=md-nav__link> countIf </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-min-if/ class=md-nav__link> minIf </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-max-if/ class=md-nav__link> maxIf </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-sum-if/ class=md-nav__link> sumIf </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-stddev-pop/ class=md-nav__link> STDDEV_POP </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/aggregate-functions/aggregate-windowfunnel/ class=md-nav__link> windowFunnel </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_8 type=checkbox id=__nav_2_2_8> <label class=md-nav__link for=__nav_2_2_8> Conditional Functions <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Conditional Functions" data-md-level=3> <label class=md-nav__title for=__nav_2_2_8> <span class="md-nav__icon md-icon"></span> Conditional Functions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/conditional-functions/if/ class=md-nav__link> IF </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_9 type=checkbox id=__nav_2_2_9> <label class=md-nav__link for=__nav_2_2_9> Conversion Functions <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Conversion Functions" data-md-level=3> <label class=md-nav__title for=__nav_2_2_9> <span class="md-nav__icon md-icon"></span> Conversion Functions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/conversion-functions/cast/ class=md-nav__link> CAST </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/conversion-functions/type-conversion/ class=md-nav__link> Type Conversion </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_10 type=checkbox id=__nav_2_2_10> <label class=md-nav__link for=__nav_2_2_10> Date and Time Functions <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Date and Time Functions" data-md-level=3> <label class=md-nav__title for=__nav_2_2_10> <span class="md-nav__icon md-icon"></span> Date and Time Functions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/datetime-functions/now/ class=md-nav__link> NOW </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/datetime-functions/today/ class=md-nav__link> TODAY </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/datetime-functions/tomorrow/ class=md-nav__link> TOMORROW </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/datetime-functions/toyyyymm/ class=md-nav__link> toYYYYMM </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/datetime-functions/toyyyymmdd/ class=md-nav__link> toYYYYMMDD </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/datetime-functions/toyyyymmddhhmmss/ class=md-nav__link> toYYYYMMDDhhmmss </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/datetime-functions/tostartofyear/ class=md-nav__link> toStartOfYear </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/datetime-functions/tostartofisoyear/ class=md-nav__link> toStartOfISOYear </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/datetime-functions/yesterday/ class=md-nav__link> YESTERDAY </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/datetime-functions/addinterval/ class=md-nav__link> addYEARS/MONTHS/DAYS/HOURS/MINUTES/SECONDS </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/datetime-functions/subtractinterval/ class=md-nav__link> subtractYEARS/MONTHS/DAYS/HOURS/MINUTES/SECONDS </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_11 type=checkbox id=__nav_2_2_11> <label class=md-nav__link for=__nav_2_2_11> Hash Functions <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Hash Functions" data-md-level=3> <label class=md-nav__title for=__nav_2_2_11> <span class="md-nav__icon md-icon"></span> Hash Functions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/hash-functions/siphash/ class=md-nav__link> SIPHASH </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_12 type=checkbox id=__nav_2_2_12> <label class=md-nav__link for=__nav_2_2_12> Information Functions <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Information Functions" data-md-level=3> <label class=md-nav__title for=__nav_2_2_12> <span class="md-nav__icon md-icon"></span> Information Functions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/information-functions/database/ class=md-nav__link> DATABASE </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/information-functions/version/ class=md-nav__link> VERSION </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_13 type=checkbox id=__nav_2_2_13> <label class=md-nav__link for=__nav_2_2_13> Nullable Functions <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Nullable Functions" data-md-level=3> <label class=md-nav__title for=__nav_2_2_13> <span class="md-nav__icon md-icon"></span> Nullable Functions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/nullable-functions/isnull/ class=md-nav__link> isNull </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/nullable-functions/isnotnull/ class=md-nav__link> isNotNull </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_14 type=checkbox id=__nav_2_2_14> <label class=md-nav__link for=__nav_2_2_14> String Functions <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="String Functions" data-md-level=3> <label class=md-nav__title for=__nav_2_2_14> <span class="md-nav__icon md-icon"></span> String Functions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/string-functions/substring/ class=md-nav__link> SUBSTRING </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_15 type=checkbox id=__nav_2_2_15> <label class=md-nav__link for=__nav_2_2_15> Test Functions <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Test Functions" data-md-level=3> <label class=md-nav__title for=__nav_2_2_15> <span class="md-nav__icon md-icon"></span> Test Functions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/test-functions/sleep/ class=md-nav__link> SLEEP </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/test-functions/crashme/ class=md-nav__link> CRASHME </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2_16 type=checkbox id=__nav_2_2_16> <label class=md-nav__link for=__nav_2_2_16> Other Functions <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Other Functions" data-md-level=3> <label class=md-nav__title for=__nav_2_2_16> <span class="md-nav__icon md-icon"></span> Other Functions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sqlstatement/other-functions/totypename/ class=md-nav__link> ToTypeName </a> </li> <li class=md-nav__item> <a href=../../../sqlstatement/other-functions/running-difference/ class=md-nav__link> runningDifference </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../system/system-tables/ class=md-nav__link> System Tables </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3 type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3> API <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=API data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> API </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../api/config/ class=md-nav__link> Config </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../cli/cli/ class=md-nav__link> CLI </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4> Development <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Development data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../development/contributing/ class=md-nav__link> Contributing </a> </li> <li class=md-nav__item> <a href=../../../development/coding-guidelines/ class=md-nav__link> Coding Guideline </a> </li> <li class=md-nav__item> <a href=../../../development/how-to-write-aggregate-functions/ class=md-nav__link> How to write aggregate functions </a> </li> <li class=md-nav__item> <a href=../../../development/tracing/ class=md-nav__link> Tracing </a> </li> <li class=md-nav__item> <a href=../../../development/profiling/ class=md-nav__link> Profling </a> </li> <li class=md-nav__item> <a href=../../../development/roadmap/ class=md-nav__link> Roadmap </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_7 type=checkbox id=__nav_4_7 checked> <label class=md-nav__link for=__nav_4_7> RFCs <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=RFCs data-md-level=2> <label class=md-nav__title for=__nav_4_7> <span class="md-nav__icon md-icon"></span> RFCs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../0001-join-framework-design/ class=md-nav__link> DatabendQuery Join </a> </li> <li class=md-nav__item> <a href=../0002-plan-expression/ class=md-nav__link> DatabendQuery Expression </a> </li> <li class=md-nav__item> <a href=../0003-data-shuffle/ class=md-nav__link> DatabendQuery Shuffle </a> </li> <li class=md-nav__item> <a href=../0004-performance-test/ class=md-nav__link> Performance Test </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <a href=./ class="md-nav__link md-nav__link--active"> SQL Planner Framework </a> </li> <li class=md-nav__item> <a href=../../cli/0001-cli-design/ class=md-nav__link> DatabendCLI Design </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../overview/performance/ class=md-nav__link> Performance </a> </li> <li class=md-nav__item> <a href=../../../overview/architecture/ class=md-nav__link> Whitepapers </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/datafuselabs/databend/tree/main/website/databend/docs/rfcs/query/0005-new-sql-planner-framework.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <ul> <li>Start date: 2021/09/13</li> <li>Tracking issues: <a href=https://github.com/datafuselabs/databend/issues/1217>https://github.com/datafuselabs/databend/issues/1217</a></li> </ul> <h1 id=sumamry>Sumamry<a class=headerlink href=#sumamry title="Permanent link">&para;</a></h1> <p>In order to support more complicated SQL queries, for example the queries contain <code>JOIN</code> and correlated subquery, we need to redesign the SQL planner component.</p> <p>The main problems of current implementation we are going to discussed in this RFC are as follows:</p> <ul> <li>Doesn't support <code>JOIN</code> and correlated subquery</li> <li>Doesn't have ability to do strict semantic checking, e.g. type check and name resolution, which brings unnecessary complexity of correctness ensurance during SQL optimization and execution</li> <li>Doesn't have a universal SQL optimization framework</li> </ul> <p>Let's start with a simple example.</p> <p>In SQL, it allows duplicated names of fields in a tuple. In PostgreSQL, a result set can contain different columns with same name:</p> <div class=highlight><pre><span></span><code>postgres=# create table t(a int);
CREATE TABLE
postgres=# insert into t values(1),(2);
INSERT 0 2
postgres=# select * from t t1 cross join t t2;
 a | a
---+---
 1 | 1
 1 | 2
 2 | 1
 2 | 2
(4 rows)
</code></pre></div> <p>We can see that there are two fields named with <code>a</code>, one of them comes from derived table <code>t1</code> and the other one comes from derived table <code>t2</code>.</p> <p>If you try to reference the column with duplicated name <code>a</code>, it will return an error:</p> <div class=highlight><pre><span></span><code>postgres=# select a from t t1, t t2;
ERROR:  column reference &quot;a&quot; is ambiguous
LINE 1: select a from t t1, t t2;
</code></pre></div> <p>While you can reference the column with a canonical name like <code>t.a</code> since the table name is required to be unique in a query context.</p> <p>Currently, <code>databend</code> uses <code>DataSchema</code> to represent input and output relation schema, which can not provide enough information to handle the case shown above. In a <code>DataSchema</code>, each column is represented with <code>DataField</code>, which has following definition:</p> <div class=highlight><pre><span></span><code><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>DataField</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>data_type</span>: <span class=nc>DataType</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>nullable</span>: <span class=kt>bool</span><span class=p>,</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>Each <code>DataField</code> inside a <code>DataSchema</code> is identified with a unique <code>name</code> string. For now, the <code>name</code> just represent column name, thus it's difficult to implement <code>JOIN</code> with this abstraction. We will talk about the detailed solution of this in later sections.</p> <p>The second problem is about semantic check.</p> <p>Take type check as an example, each variable(e.g. column reference, constant value) inside an expression has it's own data type. And each scalar expresiion has requirement of data type for its arguments, for instance, a <code>+</code> expression requires its arguments to be numeric.</p> <p>To make sure that the query is valid and correct, we need to do type checking before executing the query.</p> <p>Since both optimizer and executor has requirement on type checking, it's better to resolve this with a single component, which can make it more maintainable.</p> <p>The last problem is about the query optimization framework.</p> <p>Many of modern optimizers are implemented in Volcano/Cascades style, which is a highly modular approach.</p> <p>A typical Cascades optimizer consists of independent modules:</p> <ul> <li>Transformation rules</li> <li>Implementation rules</li> <li>Exploration engine</li> <li>Cost model</li> </ul> <p>What's insteresting is that, the rule system(transformation and implementation) is decoupled with exploration engine and cost model, which means it's easy to build a heuristic optimizer without CBO(cost based optimization). And as soon as we're going to implement CBO, the rule system can be reused.</p> <p>Actually, this is the practical way. In some industrial Cascades implementation(e.g. SQL Server and CockroachDB), there is always a heuristic optimization phase, for example <code>pre-exploration</code> in SQL Server and <code>normalization</code> in CockroachDB, which generally shares a same rule system with exploration engine.</p> <p>In summary, this RFC will:</p> <ul> <li>Introduce a new framework to support planning <code>JOIN</code> and correlated subquery</li> <li>Introduce a rule system that allows developer to write transformation rules easily</li> </ul> <h1 id=design-details>Design Details<a class=headerlink href=#design-details title="Permanent link">&para;</a></h1> <h2 id=architecture>Architecture<a class=headerlink href=#architecture title="Permanent link">&para;</a></h2> <p>In current implementation, a SQL query will be processed as follows:</p> <ol> <li><code>PlanParser</code> will parse the SQL text into AST(Abstrct Syntax Tree)</li> <li><code>PlanParser</code> will also build a canonical plan tree represented with <code>PlanNode</code> from the AST</li> <li>After building plan tree, <code>Optimizer</code> will do some canonical optimization to the plan, and produce the final <code>PlanNode</code></li> <li><code>Intepreter</code> will take the <code>PlanNode</code> as input and interpret it as an executable <code>Pipeline</code> consists of <code>Processor</code>s</li> <li>Executor will execute the <code>Pipeline</code> with specific runtime</li> </ol> <p>In our new framework, <code>PlanParser</code> will be refactored into two components:</p> <ul> <li><code>Parser</code>: parsing SQL text into uniform AST representation, which has been introduced in <a href=https://github.com/datafuselabs/databend/pull/1478>this PR</a></li> <li><code>Binder</code>: bind variables appeared in the AST with objects(e.g. tables, columns, etc) in database and perform semantic check(name resolution, type checking). Will produce logical representation of plan tree</li> </ul> <p>Besides, a <code>rule system</code> will be introduced and replace current optimizer.</p> <h2 id=binder>Binder<a class=headerlink href=#binder title="Permanent link">&para;</a></h2> <p>Since there maybe many syntactic contexts in a SQL query, we need a way to track the dependency relationship between them and the visibility of <code>name</code>s in different contexts.</p> <p>Here we propose the abstraction <code>Metadata</code>, which stores all the metadata we need for query optimization, including base tables from catalog, derived tables(subquery and join) and columns. Each table and column will be assigned with a unique identifier.</p> <div class=highlight><pre><span></span><code><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Metadata</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>tables</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>TableEntry</span><span class=o>&gt;</span><span class=p>,</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>TableEntry</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>index</span>: <span class=nc>IndexType</span><span class=p>,</span><span class=w> </span><span class=c1>// Index of the table in `Metadata`</span>
<span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>columns</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>ColumnEntry</span><span class=o>&gt;</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=c1>// And metadata about the table, e.g. name, database name and etc.</span>
<span class=p>}</span><span class=w></span>

<span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>ColumnEntry</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>index</span>: <span class=nc>ColumnIndex</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=c1>// And metadata about the column, e.g. name, data type and etc.</span>
<span class=p>}</span><span class=w></span>

<span class=k>pub</span><span class=w> </span><span class=k>type</span> <span class=nc>IndexType</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span><span class=w></span>

<span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>ColumnIndex</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>table_index</span>: <span class=nc>IndexType</span><span class=p>,</span><span class=w> </span><span class=c1>// Index of the table this column belongs to</span>
<span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>column_index</span>: <span class=nc>IndexType</span><span class=p>,</span><span class=w> </span><span class=c1>// Index of the column inside its `TableEntry`</span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>Therefore, after name resolution each variable will be bound with a unique <code>ColumnIndex</code> but not a string, so we don't need to worry about the issues like duplicated name.</p> <p>During the binding procedure, we need to track the state of binding. The state may contain the following information:</p> <ul> <li>Visible columns in current context, used when processing wildcard result set(<code>SELECT * FROM t</code>)</li> <li>If a column in a context is group by key or not</li> <li>If a column is derived column(i.e. projection like <code>a+1 AS a</code>) or not</li> <li>If a variable is from current subquery or not, to identify correlated column reference</li> </ul> <p>To maintain the state, we propose a data structure <code>BindContext</code>(this name is inspired by <code>BinderContext</code> from CMU Peloton, which is a very appropriate name in my mind).</p> <p><code>BindContext</code> is a stack-like structure, each <code>BindContext</code> node in the stack records state of corresponding syntactic context. SQL binding is a bottom-up procedure, which means it will process AST recursively, add columns produced by data source(e.g. table scan, join, subquery) into </p> <p>Briefly, <code>BindContext</code> is a set of column references. To be clear, we will use diagram to explain hwo this mechanism works.</p> <p>Take this example:</p> <div class=highlight><pre><span></span><code><span class=k>create</span> <span class=k>table</span> <span class=n>t</span> <span class=p>(</span><span class=n>a</span> <span class=nb>int</span><span class=p>);</span>

<span class=k>select</span> <span class=o>*</span> <span class=k>from</span> <span class=n>t</span> <span class=c1>-- table: context 1 [t.a]</span>
<span class=k>cross</span> <span class=k>join</span> <span class=n>t</span> <span class=n>t1</span> <span class=c1>-- table: context 2 [t1.a]</span>
<span class=c1>-- join: context 3 [t.a, t1.a]</span>
<span class=k>where</span> <span class=n>t</span><span class=p>.</span><span class=n>a</span> <span class=o>=</span> <span class=mi>1</span>
</code></pre></div> <p>According to semantic of SQL, we can describe the binding procedure as follows:</p> <ol> <li>Create an empty <code>BindContext</code> context 1 for table <code>t</code>, and fill it with columns from <code>t</code></li> <li>Create an empty <code>BindContext</code> context 2 for table <code>t</code>, fill it with columns from <code>t</code>, and rename the table to <code>t1</code></li> <li>Create an empty <code>BindContext</code> context 3 for <code>t cross join t1</code>, and fill it with columns from <code>t</code> and <code>t1</code></li> <li>Perform name resolution for predicate <code>t.a = 1</code></li> <li>Lookup context 3, and find the corresponding <code>ColumnEntry</code> for variable <code>t.a</code></li> </ol> <p>Let's take a look at how <code>BindContext</code> handles correlated subquery.</p> <p>A correlated subquery indicates that the subquery depends on a column from outer context.</p> <p>There is a canonical <code>Apply</code> operator to execute correlated subquery, which will evaluate the subquery expression for each tuple(like a cross join). While most of the correlated subqueries can be decorrelated into join(e.g. semi-join, anti-semi-join and etc.).</p> <p>Take this query as example:</p> <div class=highlight><pre><span></span><code><span class=k>create</span> <span class=k>table</span> <span class=n>t</span> <span class=p>(</span><span class=n>a</span> <span class=nb>int</span><span class=p>);</span>

<span class=k>select</span> <span class=o>*</span> <span class=k>from</span> <span class=n>t</span> <span class=c1>-- table: context 1 [t.a]</span>
<span class=k>where</span> <span class=k>exists</span> <span class=p>(</span>
    <span class=k>select</span> <span class=o>*</span> <span class=k>from</span> <span class=n>t</span> <span class=n>t1</span> <span class=c1>-- table: context 2 with parent 1 [t1.a]</span>
    <span class=k>where</span> <span class=n>t1</span><span class=p>.</span><span class=n>a</span> <span class=o>=</span> <span class=n>t</span><span class=p>.</span><span class=n>a</span> <span class=c1>-- t.a is a correlated column since it comes from t that appears in outer query</span>
<span class=p>);</span>
</code></pre></div> <p>Before binding the <code>exists</code> subquery, we will create a new <code>BindContext</code> for it, and pass the outer <code>BindContext</code> as its parent context.</p> <p>When we bind the correlated column reference <code>t.a</code> inside the subquery, we will first lookup current <code>BindContext</code> to see if it exists an appropriate column, if not, then we will keep trying to do the lookup in parent context until we find the corresponding column or we exhaust all the parents.</p> <p>If we find the column in parent context, then we can confirm that this subquery is a correlated subquery, and the column reference bound with parent context is the correlated column.</p> <p>The procedure can be summarized as follows:</p> <ol> <li>Create an empty <code>BindContext</code> context 1 for table <code>t</code>, and fill it with columns from <code>t</code></li> <li>Create an empty <code>BindContext</code> context 2 for table <code>t</code> with context 1 as its parent cotext, fill it with columns from <code>t</code>, and rename the table to <code>t1</code></li> <li>Perform name resolution for predicate <code>t1.a = t.a</code></li> <li>Lookup context 2, and find the corresponding <code>ColumnEntry</code> for variable <code>t1.a</code>, but can not find <code>t.a</code>. So we will keep going through step 5</li> <li>Lookup parent of context 2(context 1), and find the corresponding <code>ColumnEntry</code> for variable <code>t.a</code>. Since the variable is found in outer context, it will be marked as correlated column reference, and the subquery will be marked as correlated</li> </ol> <h2 id=optimizer-rule-system>Optimizer &amp; Rule system<a class=headerlink href=#optimizer-rule-system title="Permanent link">&para;</a></h2> <p>SQL optimization is based on the equivalence of relational algebra. There are a bunch of different thereoms and lemmas can help us identify if two relational algebra trees are logically equivalent.</p> <p>In Cascades/Volcano style query optimizer, transformation rules are used to perform the algebra transformation on a plan tree.</p> <p>Each transformation rule has description about the relational operator it can be applied to, which we call it a <code>rule pattern</code>. The optimizer will provide a scheme to walk through the plan tree, check if any rule can be applied to the plan tree, and then apply transformation for the matched rules.</p> <p>The <code>rule pattern</code> is also a tree structure, which will look like:</p> <div class=highlight><pre><span></span><code><span class=k>pub</span><span class=w> </span><span class=k>trait</span><span class=w> </span><span class=n>RulePattern</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>fn</span> <span class=nf>get_children_pattern</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=nb>Box</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>RulePattern</span><span class=o>&gt;&gt;</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>fn</span> <span class=nf>match</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>plan</span>: <span class=kp>&amp;</span><span class=nc>PlanNode</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>The transformation rule should implement the following trait:</p> <div class=highlight><pre><span></span><code><span class=k>pub</span><span class=w> </span><span class=k>trait</span><span class=w> </span><span class=n>TransformationRule</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>fn</span> <span class=nf>get_rule_pattern</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=nc>dyn</span><span class=w> </span><span class=n>RulePattern</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>fn</span> <span class=nf>apply</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>plan</span>: <span class=kp>&amp;</span><span class=nc>PlanNode</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>PlanNode</span><span class=o>&gt;</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>With these rule abstraction, we can write transformation rules easily. For example, we want to implement <code>ConstantFolding</code> transformation, the scheme can be described as:</p> <ol> <li>Find all operators with scalar expressions</li> <li>Fold the constant values found in scalar expressions</li> <li>Replace original operators with rewritten operators</li> </ol> <p>The pseudo code:</p> <div class=highlight><pre><span></span><code><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>ConstantFoldingPattern</span><span class=p>;</span><span class=w></span>

<span class=k>impl</span><span class=w> </span><span class=n>RulePattern</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>ConstantFoldingPattern</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>fn</span> <span class=nf>get_children_pattern</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Vec</span><span class=o>&lt;</span><span class=nb>Box</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>RulePattern</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=fm>vec!</span><span class=p>[]</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>fn</span> <span class=nf>match</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>plan</span>: <span class=kp>&amp;</span><span class=nc>PlanNode</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=o>!</span><span class=n>plan</span><span class=p>.</span><span class=n>expr</span><span class=p>.</span><span class=n>empty</span><span class=p>()</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>ConstantFoldingRule</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>pattern</span>: <span class=nc>ConstantFoldingPattern</span><span class=p>,</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=k>impl</span><span class=w> </span><span class=n>TransformationRule</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>ConstantFoldingRule</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>fn</span> <span class=nf>get_rule_pattern</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=nc>dyn</span><span class=w> </span><span class=n>RulePattern</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>pattern</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>fn</span> <span class=nf>apply</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>plan</span>: <span class=kp>&amp;</span><span class=nc>PlanNode</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>PlanNode</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>new_expr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>plan</span><span class=p>.</span><span class=n>get_expr</span><span class=p>().</span><span class=n>constant_folding</span><span class=p>()</span><span class=o>?</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>new_plan</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>plan</span><span class=p>.</span><span class=n>clone</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=n>new_plan</span><span class=p>.</span><span class=n>set_expr</span><span class=p>(</span><span class=n>new_expr</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>new_plan</span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Optimizer</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>rules</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=nb>Box</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>TransformationRule</span><span class=o>&gt;&gt;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=k>impl</span><span class=w> </span><span class=n>ReplaceVisitor</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Optimizer</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>fn</span> <span class=nf>visit</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>plan</span>: <span class=kp>&amp;</span><span class=nc>PlanNode</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>PlanNode</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>new_plan</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>plan</span><span class=p>.</span><span class=n>clone</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>rule</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>rules</span><span class=p>.</span><span class=n>iter</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=n>rule</span><span class=p>.</span><span class=n>get_rule_pattern</span><span class=p>().</span><span class=k>match</span><span class=p>(</span><span class=n>plan</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=n>new_plan</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rule</span><span class=p>.</span><span class=n>apply</span><span class=p>(</span><span class=o>&amp;</span><span class=n>new_plan</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>new_plan</span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>optimize</span><span class=p>(</span><span class=n>plan</span>: <span class=kp>&amp;</span><span class=nc>PlanNode</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>PlanNode</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>opt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Optimizer</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>rules</span>: <span class=nc>vec</span><span class=o>!</span><span class=p>[</span><span class=n>ConstantFoldingRule</span>::<span class=n>new</span><span class=p>()],</span><span class=w> </span><span class=p>};</span><span class=w></span>
<span class=w>    </span><span class=n>opt</span><span class=p>.</span><span class=n>visit</span><span class=p>(</span><span class=n>plan</span><span class=p>)</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <h1 id=milestone>Milestone<a class=headerlink href=#milestone title="Permanent link">&para;</a></h1> <p>After this refactoring, we want:</p> <ul> <li>Provide naive implementation(hash join for equi-join and nested-loop join for cross join) for <code>JOIN</code>, including planning and execution</li> <li>Support running most of the queries from TPCH benchmark(contains different types of joins and correlated subquery) with <code>databend</code></li> <li>Implement several simple optimization rules, e.g. outer join elimination, decorrelation, predicate pushdown and etc.</li> <li>Migrate to the new planner framework</li> </ul> <p>And at the same time, we won't:</p> <ul> <li>Take performance serious, related work should be done in next stage</li> <li>Implement cost based optimization, this work depends on design of statistics system</li> </ul> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../0004-performance-test/ class="md-footer__link md-footer__link--prev" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Performance Test </div> </div> </a> <a href=../../cli/0001-cli-design/ class="md-footer__link md-footer__link--next" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> DatabendCLI Design </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2020 - 2021 Datafuse Labs </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://github.com/datafuselabs target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.sections", "navigation.tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../../assets/javascripts/workers/search.d351de03.min.js", "version": null}</script> <script src=../../../assets/javascripts/bundle.8c5b30be.min.js></script> </body> </html>